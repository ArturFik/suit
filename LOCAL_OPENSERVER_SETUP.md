# Локальный запуск проекта suit на OpenServer

## 1. Подготовка окружения

1. Скачайте и установите OpenServer (рекомендуется последняя версия x64).
2. В настройках OpenServer:
   - PHP: используйте не ниже 7.4 (проверенная версия для OpenCart 3.x).
   - Apache или Nginx — выберите любой из комплектных веб-серверов (Apache 2.4 по умолчанию подходит).
   - MySQL: активируйте MySQL-8.0 (если нет, установите через модульный менеджер OpenServer).

## 2. Настройка домена и корня сайта

1. В панели OpenServer (ПКМ по иконке в трее → «Настройки») откройте вкладку «Домены».
   1. Нажмите «Добавить».
   2. В поле «Домен/алиас» укажите `suit`.
   3. В поле «Папка» выберите `D:/ip/suit`.
   4. Убедитесь, что напротив домена стоит галочка (домен активен в списке).
2. Нажмите «Применить»/«ОК», чтобы сохранить изменения.
3. Пропишите домен в файле `hosts`:
   1. Запустите «Блокнот» от имени администратора.
   2. В меню _Файл → Открыть_ выберите «Все файлы (_._)», перейдите в `C:\Windows\System32\drivers\etc\` и откройте файл `hosts`.
   3. В конце файла на новой строке допишите:
      ```
      127.0.0.1   suit
      ```
   4. Сохраните изменения (_Ctrl+S_) и закройте редактор.
4. Перезапустите OpenServer для применения настроек.

## 3. Конфигурация OpenCart

1. Файл [`config.php`](suit/config.php:1) уже обновлён под локальное окружение:
   - `HTTP/HTTPS_SERVER` указывает на `http://suit/`.
   - Пути `DIR_*` скорректированы на `D:/ip/suit/...`.
   - Подключение к БД настроено на MySQL `root:root@127.0.0.1` и базу `ibmax_local`.
2. Файл [`admin/config.php`](suit/admin/config.php:1) синхронизирован с тем же доменом и директориями (`http://suit/` и `http://suit/admin/`).
3. В контроллере [`catalog/controller/extension/module/formcreator_config.php`](suit/catalog/controller/extension/module/formcreator_config.php:1) Python API направлен на `http://127.0.0.1:8000/invoice/create`.

## 4. Подготовка базы данных

1. Запустите OpenServer и откройте phpMyAdmin (`http://localhost/index.php?mode=phpmyadmin` или `http://suit/index.php?mode=phpmyadmin`).
2. Создайте базу данных `ibmax_local` в кодировке `utf8mb4_general_ci`.
   - В разделе «SQL» выполните запрос:
     ```sql
     CREATE DATABASE IF NOT EXISTS ibmax_local CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
     ```
   - Если вы работаете через консоль MySQL, выполните:
     ```
     mysql -u root -p
     CREATE DATABASE IF NOT EXISTS ibmax_local CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
     ```
3. Импортируйте дамп OpenCart (из продакшена или чистый установочный). Убедитесь, что все таблицы начинаются с префикса `oc_`.
   - Перед импортом в phpMyAdmin обязательно сначала щёлкните по базе `ibmax_local` в левом меню, чтобы она была выбрана (в заголовке появится `База данных: ibmax_local`). Только после выбора переходите на вкладку «Импорт». Иначе возникнет ошибка `#1046 – No database selected`.
   - Если вы запускаете SQL вручную, добавьте строку `USE ibmax_local;` перед блоком `CREATE TABLE` или выполняйте команды уже внутри выбранной базы (`mysql> use ibmax_local;`).
   - Если phpMyAdmin сообщает, что файл слишком большой, увеличьте лимиты:
     1. В OpenServer откройте «Настройки» → «Сервер» → вкладка PHP → кнопка «Настроить php.ini».
     2. Найдите и измените параметры (значения в мегабайтах):
        ```
        upload_max_filesize = 256M
        post_max_size = 256M
        max_execution_time = 300
        memory_limit = 512M
        ```
     3. В файле `OpenServer/userdata/php/php.ini` (если используется пользовательский профиль) продублируйте эти значения.
     4. Перезапустите OpenServer. После рестарта phpMyAdmin принимает larger файлы.
     5. Для огромных дампов используйте консоль MySQL:
        ```
        mysql -u root -p ibmax_local < dump.sql
        ```
4. Проверьте пользователя:
   - Локально достаточно пользователя `root` с паролем `root`.
   - Если используется другой пользователь, обновите параметры в [`config.php`](suit/config.php:24) и [`admin/config.php`](suit/admin/config.php:27).

## 5. Устранение конфликта порта MySQL 3306

1. Если порт `3306` уже занят (например, службу `c:\Program Files\MySQL\MySQL Server 8.0\bin\mysqld.exe` запускает системная MySQL), используйте один из вариантов:
   - **Вариант A.** Остановите системную службу `MySQL80` через `services.msc` или командой `net stop MySQL80` перед стартом OpenServer.
   - **Вариант B.** В настройках OpenServer → «Модули» → `MySQL` → «Свойства» смените порт на свободный (например, `3307`). После этого обновите параметр `DB_PORT` в [`config.php`](suit/config.php:30), [`admin/config.php`](suit/admin/config.php:32) и других местах, где используется строка подключения.
   - **Вариант C.** Оставьте запущенной системную MySQL и отключите модуль MySQL в OpenServer, используя внешний экземпляр по `127.0.0.1:3306`.
2. После выбранного действия перезапустите OpenServer, чтобы освободить порт и применить новую конфигурацию.

## 6. Очистка кэша и модификаций

1. Удалите содержимое директорий:
   - `suit/system/storage/cache/`
   - `suit/system/storage/modification/`
   - `suit/system/storage/session/`
2. Либо сделайте это через админку OpenCart: «Extensions → Modifications → Refresh».

## 7. Запуск FastAPI сервиса (интеграция)

1. Поднимите сервис документов (FastAPI) согласно инструкции в `Site-parser`.
2. Убедитесь, что эндпоинт `http://127.0.0.1:8000/invoice/create` отдаёт ответ.
3. Для проверки веб-формы воспользуйтесь `test_form_site.html` или мануалом [`README_INTEGRATION.md`](README_INTEGRATION.md:1).

## 8. Диагностика проблем с доступом

1. Если `http://suit/` не открывается и браузер сообщает `ERR_NAME_NOT_RESOLVED`:
   - Убедитесь, что запись `127.0.0.1   suit` действительно присутствует в `C:\Windows\System32\drivers\etc\hosts` активной строкой: без ведущего `#` и без лишних символов (например, табов в начале строки).
   - Проверьте, что антивирус или VPN не перехватывают файл hosts.
   - Выполните команду `ipconfig /flushdns` в `cmd` (администратор), затем перезапустите браузер.
   - Убедитесь, что OpenServer запущен, а домен `suit` отображается в списке активных (зелёная иконка).
2. Если при открытии `http://localhost/` показывается приветственная страница OpenServer («Добро пожаловать!»), это нормально: главная директория `localhost` указывает на системную заглушку. Для доступа к проекту используйте `http://suit/`.
3. Ошибка `Site error: the ionCube PHP Loader needs to be installed` означает, что loader не подключен:

   - Если ваша сборка OpenServer не содержит вкладку «Дополнительно», подключите Loader вручную:
     1. Узнайте используемую версию PHP (Настройки → Сервер → PHP), например `PHP_8.1`.
     2. Скачайте архив с https://www.ioncube.com/loaders.php (Windows x86-64 Thread Safe для соответствующей версии).
     3. Скопируйте файл `ioncube_loader_win_{версия}.dll` из архива в каталог расширений PHP, например `C:\OpenServer\modules\php\PHP_8.1\ext\`.
     4. Откройте `C:\OpenServer\modules\php\PHP_8.1\php.ini` (либо `OpenServer/userdata/php/php.ini`, если используете пользовательский файл) и добавьте строку:
        ```
        zend_extension = "${PHPEXTDIR}\ioncube_loader_win_8.1.dll"
        ```
        (подставьте свою версию).
     5. Сохраните файл, полностью перезапустите OpenServer (Stop → Start).
     6. Создайте `D:/ip/suit/info.php` с `<?php phpinfo(); ?>`, откройте `http://suit/info.php` и убедитесь, что раздел ionCube отображается. После проверки удалите файл.

4. Если при вызове `http://localhost/index.php?mode=phpmyadmin` появляется «Error 404»:
   - В OpenServer → «Настройки» → «Домены» добавьте (или отредактируйте) домен/алиас `localhost`, указав путь `D:/OpenServer/domains/default` или `OpenServer/modules/system/html` (в зависимости от версии).
   - Убедитесь, что модуль phpMyAdmin установлен и включён (OpenServer → «Модули» → «Дополнительно»).
   - Сохраните изменения и перезапустите OpenServer.
   - После перезапуска попробуйте открыть `http://localhost/index.php?mode=phpmyadmin` ещё раз; если всё настроено верно, откроется phpMyAdmin.
5. Если домен открывается, но сайт 404 внутри OpenCart:
   - Проверьте пути `DIR_*` и `HTTP_SERVER` в [`config.php`](suit/config.php:1) и [`admin/config.php`](suit/admin/config.php:1).
   - Очистите кэш и модификации (см. следующий раздел).

## 9. Финальная проверка

1. Откройте `http://suit/` — должен открыться фронт магазина.
2. Войдите в админку по `http://suit/admin/` (учётные данные импортируются из дампа).
3. Проверьте разделы:
   - Конфигурация модулей интеграции (Form Creator).
   - Заказы, каталоги, формы — для корректности путей.
4. Если появляются ошибки:
   - Просмотрите логи в `suit/system/storage/logs/`.
   - Убедитесь в корректности прав на папки `system/storage`.

## 10. Дополнительные рекомендации

1. Для корректной работы почты настройте SMTP в админке.
2. Перенесите чувствительные токены из открытых файлов (например, в `.env`).
3. Настройте резервное копирование базы и файлов в OpenServer.
4. После успешного теста перенесите изменения конфигураций в систему контроля версий с исключением секретов.

Теперь проект готов к локальному запуску без Docker в связке с OpenServer.
